name: Build Debian repo and publish to gh-pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dpkg-dev
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      - name: Prepare repo directory and copy debs
        run: |
          rm -rf repo || true
          mkdir -p repo
          # Copy .deb files from repository's debs/ (adjust if you use a different path)
          if [ -d "./debs" ]; then
            cp -r debs/* repo/ || true
          fi
          # Also copy any top-level .deb files (if user placed .deb at repo root)
          cp -n *.deb repo/ 2>/dev/null || true
          ls -la repo || true

      - name: Generate Packages and Packages.gz
        working-directory: repo
        run: |
          # If repo is empty, create an empty Packages file to avoid ci failure
          if [ -z "$(ls -A .)" ]; then
            echo "No .deb files found - creating empty Packages" > Packages
            gzip -9c Packages > Packages.gz
          else
            dpkg-scanpackages . /dev/null > Packages
            gzip -9c Packages > Packages.gz
          fi
          # Generate a minimal Release file (optional)
          cat > Release <<'EOF'
Origin: GitHub
Label: GitHub
Suite: stable
Version: 1.0
Codename: stable
Architectures: iphoneos-arm iphoneos-arm64
Components: main
Description: Debian repo generated by GitHub Actions
EOF
          sha256sum Packages Packages.gz Release || true

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./repo
